<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERIFICAR DESEMPENHO DO ALUNO- Simulados Interativos</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Variáveis de Tema (Design System Básico) */
        :root {
            --primary-color: #004d99; /* Azul Profundo */
            --secondary-color: #fca311; /* Laranja de Destaque */
            --success-color: #28a745; /* Verde para Acerto */
            --danger-color: #dc3545; /* Vermelho para Erro */
            --warning-color: #ffc107; /* Amarelo para Atenção */
            --bg-light: #f9fbfd; /* Fundo Leve */
            --bg-dark: #212529; /* Barra Lateral Escura */
            --text-dark: #343a40;
            --text-light: #fff;
            --border-color: #e9ecef;
            --card-bg: #ffffff;
        }

        /* Estilos Globais */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            display: flex;
            min-height: 100vh;
        }
        
        /* Layout */
        #sidebar {
            width: 300px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            overflow-y: auto;
        }

        #content {
            flex-grow: 1;
            padding: 30px;
            max-width: calc(100% - 300px);
            overflow-y: auto;
        }

        /* Cabeçalho da Sidebar */
        #sidebar h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5em;
            margin-bottom: 30px;
            text-align: center;
            color: var(--secondary-color);
        }

        /* Lista de Simulados */
        #simulados-list {
            list-style: none;
            padding: 0;
        }

        #simulados-list li {
            margin-bottom: 10px;
        }

        #simulados-list a {
            display: block;
            background-color: #343a40;
            color: var(--text-light);
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9em;
            word-wrap: break-word; /* Garante que nomes longos se quebrem */
        }

        #simulados-list a:hover {
            background-color: var(--primary-color);
        }

        /* Conteúdo Principal do Quiz */
        .quiz-title {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        .question-card {
            background-color: var(--card-bg);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .question-header h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary-color);
            margin-top: 0;
            font-size: 1.1em;
        }
        
        .question-header p {
            font-size: 1em;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .options-list {
            list-style: none;
            padding: 0;
        }

        .option {
            background-color: #f8f9fa;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .option:hover {
            background-color: #e9ecef; 
        }

        .option-key {
            font-weight: bold;
            margin-right: 10px;
            color: var(--primary-color);
        }

        /* -------------------------------------- */
        /* ESTILOS DE INTERATIVIDADE (CORRIGIDOS) */
        /* -------------------------------------- */
        
        .option.correct-answer, .option.correct-answer-revealed {
            background-color: var(--success-color) !important; 
            color: var(--text-light);
            font-weight: bold;
        }

        .option.wrong-answer {
            background-color: var(--danger-color) !important; 
            color: var(--text-light);
        }

        /* Mantém a cor da letra escura dentro da opção, se necessário */
        .option.correct-answer .option-key,
        .option.correct-answer-revealed .option-key {
            color: var(--text-light);
        }
        .option.wrong-answer .option-key {
            color: var(--text-light);
        }

        /* Estilo para a caixa de comentário/gabarito */
        .comment-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e8f7ec; /* Fundo verde claro para comentários */
            border: 1px solid var(--success-color);
        }
        
        .comment-box h4 {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-dark);
            margin-top: 0;
            font-size: 1em;
        }
        
        .comment-box strong {
            font-weight: 700;
        }

        .text-base-card {
            background-color: #f1f8ff; /* Azul muito claro */
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .text-base-card p {
            white-space: pre-wrap; /* Mantém quebras de linha do JSON */
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1>Simulados PP ES</h1>
        <ul id="simulados-list">
            </ul>
    </div>

    <div id="content">
        <div id="quiz-container">
            <h2>Selecione um Simulado</h2>
            <p>Selecione um dos simulados na barra lateral para começar.</p>
        </div>
    </div>

    <script>
        // Variável global para armazenar as questões carregadas (necessária para o checkAnswer)
        let currentQuizData = []; 

        async function loadAndRenderQuiz(filename) {
            // Remove o foco do elemento que foi clicado
            document.activeElement.blur();
            
            try {
                // Tenta carregar o arquivo do caminho 'data/'
                const response = await fetch(`./data/${filename}`);
                if (!response.ok) {
                    throw new Error(`Erro ao carregar o arquivo: ${response.statusText}`);
                }
                const data = await response.json();
                
                // CORREÇÃO UNIVERSAL DE FORMATO: Aceita Array direto (antigo) ou Objeto com chave 'questoes' (novo)
                if (Array.isArray(data)) {
                    currentQuizData = data;
                } else if (data.questoes && Array.isArray(data.questoes)) {
                    currentQuizData = data.questoes;
                } else {
                    throw new Error("Formato JSON inválido: O arquivo não é um array nem contém a chave 'questoes'.");
                }
                
                renderQuiz(data);
            } catch (error) {
                alert(`Erro ao carregar simulado '${filename}'. Verifique o nome do arquivo, a sintaxe JSON e a pasta 'data/'.`);
                console.error("Erro no loadAndRenderQuiz:", error);
            }
        }

        function renderQuiz(data) {
            const quizContainer = document.getElementById('quiz-container');
            
            // Tenta obter o título do array ou do objeto principal
            const title = data.titulo || data.titulo_bloco || 'Simulado';
            
            quizContainer.innerHTML = `<h2 class="quiz-title">${title}</h2>`;
            
            currentQuizData.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card';
                
                // CORREÇÃO: Usa 'id' ou 'numero' para compatibilidade
                const qId = q.id || q.numero; 
                
                if (!qId) return; 

                questionDiv.id = `question-${qId}`;
                
                // ADICIONA EXIBIÇÃO DO TEXTO BASE (se a questão 1 tiver)
                // O texto base pode estar na primeira questão ou em um campo separado 'texto_base'
                if (q.texto_base && qId == 1) { 
                    const textBaseDiv = document.createElement('div');
                    textBaseDiv.className = 'text-base-card';
                    textBaseDiv.innerHTML = `
                        <h4 style="color: var(--primary-color);">[TEXTO BASE PARA INTERPRETAÇÃO - Questões 1 a 10]</h4>
                        <p>${q.texto_base.replace(/\n/g, '<br>')}</p>
                        <hr>
                    `;
                    quizContainer.appendChild(textBaseDiv);
                }
                
                // Estrutura HTML de cada questão
                // Usa replace para garantir quebras de linha do JSON/TXT sejam reconhecidas
                questionDiv.innerHTML = `
                    <div class="question-header">
                        <h3>Questão ${qId}</h3>
                        <p>${q.questao.replace(/\n/g, '<br>')}</p>
                    </div>
                    <ul class="options-list" data-question-id="${qId}">
                        ${Object.entries(q.opcoes).map(([key, value]) => `
                            <li class="option" data-option="${key.toLowerCase()}" onclick="checkAnswer(${qId}, '${key.toLowerCase()}')">
                                <span class="option-key">${key.toUpperCase()})</span> 
                                <span class="option-text">${value}</span>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="comment-box" id="comment-${qId}" style="display: none;"></div>
                `;
                quizContainer.appendChild(questionDiv);
            });
            
            // Rola para o topo do conteúdo
            document.getElementById('content').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function checkAnswer(questionId, selectedOption) {
            const questionElement = document.getElementById(`question-${questionId}`);
            
            // CORREÇÃO: Encontra a questão por 'id' ou 'numero'
            const question = currentQuizData.find(q => (q.id == questionId || q.numero == questionId));

            if (!question) return;

            const optionsList = questionElement.querySelector('.options-list');
            
            // Previne clique duplo
            if (optionsList.classList.contains('answered')) {
                return; 
            }
            optionsList.classList.add('answered'); 

            // CORREÇÃO CRÍTICA (RESOLVE O N/A): Tenta encontrar a resposta em TODAS as chaves possíveis
            const correctAnswer = (question.resposta_correta || question.resposta || question.correct_answer || '').toLowerCase(); 
            
            // ----------------------------------------------------
            // Se o gabarito não for encontrado, exibe uma mensagem de erro
            if (!correctAnswer || correctAnswer === 'n/a') {
                const commentBox = document.getElementById(`comment-${questionId}`);
                if (commentBox) {
                    commentBox.style.display = 'block';
                    commentBox.style.backgroundColor = 'var(--danger-color)';
                    commentBox.style.color = 'var(--text-light)';
                    commentBox.innerHTML = `<h4>❌ ERRO: Gabarito não definido no JSON.</h4><p>Verifique as chaves 'resposta_correta' ou 'resposta' na Questão ${questionId}.</p>`;
                }
                return;
            }
            // ----------------------------------------------------

            const isCorrect = selectedOption.toLowerCase() === correctAnswer;

            // 1. Aplica a cor de feedback
            const options = optionsList.querySelectorAll('.option');
            options.forEach(option => {
                const optionKey = option.getAttribute('data-option');
                
                if (optionKey === selectedOption) {
                    option.classList.add(isCorrect ? 'correct-answer' : 'wrong-answer');
                } else if (optionKey === correctAnswer) {
                    option.classList.add('correct-answer-revealed'); 
                }
                
                // Remove o handler de clique
                option.onclick = null;
            });

            // 2. Exibe o comentário
            const commentBox = document.getElementById(`comment-${questionId}`);
            if (commentBox) {
                commentBox.style.display = 'block';
                commentBox.style.backgroundColor = 'var(--e8f7ec)';
                commentBox.style.color = 'var(--text-dark)';
                
                let commentHTML = `<h4>${isCorrect ? '✅ Resposta Correta!' : '❌ Sua Resposta Está Incorreta.'}</h4>`;
                commentHTML += `<p><strong>Gabarito: </strong> Opção ${correctAnswer.toUpperCase()}</p>`;
                
                // CORREÇÃO: Tenta encontrar o comentário em todas as chaves e formatos
                let commentContent = '';
                
                // Prioridade 1: Formato Objeto detalhado (padrão de simulados antigos)
                if (typeof question.comentario === 'object' && question.comentario !== null) {
                    // Pega o comentário detalhado da opção correta (Formato de Objeto)
                    commentContent = question.comentario[correctAnswer.toUpperCase()] || question.comentario[correctAnswer] || question.comentario.A || 'Comentário detalhado não disponível.';
                } 
                // Prioridade 2: Chave alternativa 'explicacao_professor'
                else if (question.explicacao_professor) {
                    commentContent = question.explicacao_professor;
                }
                // Prioridade 3: Formato String Simples (padrão do seu novo JSON)
                else if (typeof question.comentario === 'string') {
                    commentContent = question.comentario;
                } 
                
                
                commentHTML += `<div class="comment-content">${commentContent.replace(/\n/g, '<br>')}</div>`;
                commentBox.innerHTML = commentHTML;
            }
        }

        // Função para carregar a lista de simulados na barra lateral
        async function loadSimulados() {
            const list = document.getElementById('simulados-list');
            try {
                // Tenta carregar o arquivo que lista os simulados (se existir)
                const response = await fetch('./data/simulados.json');
                if (!response.ok) {
                    throw new Error('simulados.json não encontrado ou erro de servidor.');
                }
                const data = await response.json();
                
                list.innerHTML = '';
                data.forEach(simulado => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a onclick="loadAndRenderQuiz('${simulado.filename}')">${simulado.name}</a>
                    `;
                    list.appendChild(li);
                });
                
            } catch (error) {
                console.error("Erro ao carregar simulados, usando lista de testes (fallback):", error);
                
                // Lista estática de fallback (AGORA INCLUI O SEU NOVO ARQUIVO)
                const fallbackFiles = [
                    "SIMULADO-POLICIA-PENAL-JSON.json", 
                    "SIMULADO-02-IDCAP-60-QUESTOES.json",
                    "SIMULADO-DIREITOS-HUMANOS-JSON.json",
                    "SIMULADO-IASES-JSON-COM-GABARITO.json",
                    "QUESTOES-AREA-POLICIAL.json",
                    "simulado_100_questoes.json",
                    "100-QUESTOES-POLICIAL.json",
                    "QUESTOES-GERAIS.json.json",
                    "NOVO SIMULADOS POLICIA PENAL 08.11.2025.json" // Seu novo arquivo adicionado aqui
                ];
                
                list.innerHTML = '';
                fallbackFiles.forEach(filename => {
                    const cleanName = filename.replace(/\\.(json|txt)$/i, ''); 
                    const li = document.createElement('li');
                    li.innerHTML = `<a onclick="loadAndRenderQuiz('${filename}')">${cleanName}</a>`;
                    list.appendChild(li);
                });
                list.innerHTML += '<li><small style="color:#adb5bd;">(Lista de testes carregada)</small></li>';
            }
        }

        window.onload = loadSimulados;
    </script>
</body>
</html>
