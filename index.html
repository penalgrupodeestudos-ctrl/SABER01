<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERIFICAR DESEMPENHO DO ALUNO - Simulados Interativos</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Variáveis de Tema (Design System Básico) */
        :root {
            --primary-color: #004d99; /* Azul Profundo */
            --secondary-color: #fca311; /* Laranja de Destaque */
            --success-color: #28a745; /* Verde para Acerto */
            --danger-color: #dc3545; /* Vermelho para Erro */
            --warning-color: #ffc107; /* Amarelo para Atenção */
            --bg-light: #f9fbfd; /* Fundo Leve */
            --bg-dark: #212529; /* Barra Lateral Escura */
            --text-dark: #343a40;
            --text-light: #fff;
            --border-color: #e9ecef;
            --card-bg: #ffffff;
        }

        /* Estilos Globais */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            display: flex;
            min-height: 100vh;
        }
        
        /* Layout */
        #sidebar {
            width: 300px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            overflow-y: auto;
        }

        #content {
            flex-grow: 1;
            padding: 30px;
            max-width: calc(100% - 300px);
            overflow-y: auto;
        }

        /* Cabeçalho da Sidebar */
        #sidebar h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5em;
            margin-bottom: 30px;
            text-align: center;
            color: var(--secondary-color);
        }

        /* Lista de Simulados */
        #simulados-list {
            list-style: none;
            padding: 0;
        }

        #simulados-list li {
            margin-bottom: 10px;
        }

        #simulados-list a {
            display: block;
            background-color: #343a40;
            color: var(--text-light);
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9em;
            word-wrap: break-word; 
        }

        #simulados-list a:hover:not(.active) {
            background-color: var(--primary-color);
        }
        
        #simulados-list a.active {
            background-color: var(--secondary-color);
            color: var(--text-dark);
            font-weight: bold;
        }

        /* Conteúdo Principal do Quiz */
        .quiz-title {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        .question-card {
            background-color: var(--card-bg);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .question-header h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary-color);
            margin-top: 0;
            font-size: 1.1em;
        }
        
        .question-header p {
            font-size: 1em;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .options-list {
            list-style: none;
            padding: 0;
        }

        .option {
            background-color: #f8f9fa;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .option:hover:not(.answered) {
            background-color: #e9ecef; 
        }

        .option-key {
            font-weight: bold;
            margin-right: 10px;
            color: var(--primary-color);
        }

        /* ESTILOS DE INTERATIVIDADE */
        .option.answered {
            pointer-events: none; 
        }
        
        .option.correct-answer, .option.correct-answer-revealed {
            background-color: var(--success-color) !important; 
            color: var(--text-light);
            font-weight: bold;
        }

        .option.wrong-answer {
            background-color: var(--danger-color) !important; 
            color: var(--text-light);
        }

        .option.correct-answer .option-key,
        .option.correct-answer-revealed .option-key,
        .option.wrong-answer .option-key {
            color: var(--text-light);
        }

        /* Estilo para a caixa de comentário/gabarito */
        .comment-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        
        .comment-box h4 {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-dark);
            margin-top: 0;
            font-size: 1em;
        }
        
        .comment-box strong {
            font-weight: 700;
        }

        /* Estilo para o Texto Base */
        .text-base-card {
            background-color: #f1f8ff; 
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .text-base-card p {
            white-space: pre-wrap; 
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1>Simulados PP ES</h1>
        <ul id="simulados-list">
            </ul>
    </div>

    <div id="content">
        <div id="quiz-container">
            <h2>Selecione um Simulado</h2>
            <p>Selecione um dos simulados na barra lateral para começar.</p>
        </div>
    </div>

    <script>
        // Variável global para armazenar as questões carregadas
        let currentQuizData = []; 
        let activeFilename = ''; // Para rastrear qual simulado está ativo

        async function loadAndRenderQuiz(filename) {
            document.activeElement.blur();
            activeFilename = filename; // Define o arquivo ativo
            
            // Atualiza o estado visual do simulado na barra lateral
            document.querySelectorAll('#simulados-list a').forEach(a => {
                a.classList.remove('active');
                if (a.getAttribute('onclick').includes(`'${filename}'`)) {
                    a.classList.add('active');
                }
            });

            try {
                // CORREÇÃO CRÍTICA: Usa encodeURIComponent para garantir que espaços e caracteres especiais funcionem no caminho
                const response = await fetch(`./data/${encodeURIComponent(filename)}`);
                
                if (!response.ok) {
                    throw new Error(`Erro de rede ao carregar. Código: ${response.status}`);
                }
                
                const data = await response.json();
                
                // CORREÇÃO UNIVERSAL DE FORMATO
                if (Array.isArray(data)) {
                    currentQuizData = data;
                } else if (data.questoes && Array.isArray(data.questoes)) {
                    currentQuizData = data.questoes;
                } else {
                    throw new Error("Formato JSON inválido: O arquivo não é um array nem contém a chave 'questoes'.");
                }
                
                renderQuiz(data);
            } catch (error) {
                // Mensagem de erro clara para o usuário
                alert(`Erro ao carregar simulado '${filename}'.\n\nVerifique:\n1. Se o arquivo está na pasta 'data/'\n2. Se o nome do arquivo está EXATO\n3. Se a sintaxe JSON está correta.\n\nDetalhes: ${error.message}`);
                console.error("Erro no loadAndRenderQuiz:", error);
                document.getElementById('quiz-container').innerHTML = `
                    <h2 style="color: var(--danger-color);">Falha ao Carregar Simulado</h2>
                    <p>Verifique se o ficheiro <strong>${filename}</strong> está na pasta <strong>data/</strong> e se o nome está exato. Consulte a consola do navegador para detalhes técnicos.</p>
                `;
            }
        }

        function renderQuiz(data) {
            const quizContainer = document.getElementById('quiz-container');
            
            const title = data.titulo || data.titulo_bloco || 'Simulado';
            
            quizContainer.innerHTML = `<h2 class="quiz-title">${title}</h2>`;
            
            currentQuizData.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card';
                
                const qId = q.id || q.numero; 
                
                if (!qId) return; 

                questionDiv.id = `question-${qId}`;
                
                let currentQuestionText = q.questao;

                // Tenta extrair e exibir o texto base se estiver na questão 1
                if (currentQuestionText && qId == 1 && currentQuestionText.includes('TEXTO BASE')) {
                     const textBaseMarker = "**[TEXTO BASE";
                     const questionMarker = "Questão 1"; 

                     // Tenta dividir o texto
                     const textBaseParts = currentQuestionText.split(textBaseMarker);
                     
                     if(textBaseParts.length > 1) {
                        const questionStart = textBaseParts[1].indexOf(questionMarker);
                        
                        let textBaseContent = currentQuestionText;
                        
                        if (questionStart > 0) {
                             textBaseContent = textBaseParts[1].substring(0, questionStart).trim();
                             currentQuestionText = textBaseParts[1].substring(questionStart).trim();
                        } else {
                            // Se a questão não estiver na mesma string, usa toda a string (solução de emergência)
                            currentQuestionText = q.questao; 
                        }

                        const textBaseDiv = document.createElement('div');
                        textBaseDiv.className = 'text-base-card';
                        textBaseDiv.innerHTML = `
                            <h4 style="color: var(--primary-color);">[TEXTO BASE PARA INTERPRETAÇÃO]</h4>
                            <p>${textBaseContent.replace(/\n/g, '<br>')}</p>
                            <hr>
                        `;
                        quizContainer.appendChild(textBaseDiv);
                     }
                }

                // Estrutura HTML de cada questão
                questionDiv.innerHTML = `
                    <div class="question-header">
                        <h3>Questão ${qId}</h3>
                        <p>${currentQuestionText.replace(/\n/g, '<br>')}</p>
                    </div>
                    <ul class="options-list" data-question-id="${qId}">
                        ${Object.entries(q.opcoes).map(([key, value]) => `
                            <li class="option" data-option="${key.toLowerCase()}" onclick="checkAnswer(${qId}, '${key.toLowerCase()}')">
                                <span class="option-key">${key.toUpperCase()})</span> 
                                <span class="option-text">${value}</span>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="comment-box" id="comment-${qId}" style="display: none;"></div>
                `;
                quizContainer.appendChild(questionDiv);
            });
            
            document.getElementById('content').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function checkAnswer(questionId, selectedOption) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const question = currentQuizData.find(q => (q.id == questionId || q.numero == questionId));

            if (!question) return;

            const optionsList = questionElement.querySelector('.options-list');
            
            if (optionsList.classList.contains('answered')) {
                return; 
            }
            optionsList.classList.add('answered'); 

            // CORREÇÃO CRÍTICA (RESOLVE O N/A): Procura a resposta correta em múltiplas chaves
            const correctAnswer = (question.resposta_correta || question.resposta || question.correct_answer || '').toLowerCase(); 
            
            if (!correctAnswer || correctAnswer === 'n/a' || correctAnswer === 'undefined') {
                const commentBox = document.getElementById(`comment-${questionId}`);
                if (commentBox) {
                    commentBox.style.display = 'block';
                    commentBox.style.backgroundColor = '#f7e8e8'; 
                    commentBox.style.borderColor = 'var(--danger-color)';
                    commentBox.innerHTML = `<h4>❌ ERRO: Gabarito não definido no JSON.</h4><p>Verifique as chaves 'resposta_correta' ou 'resposta' na Questão ${questionId}.</p>`;
                }
                return;
            }

            const isCorrect = selectedOption.toLowerCase() === correctAnswer;

            // 1. Aplica a cor de feedback
            const options = optionsList.querySelectorAll('.option');
            options.forEach(option => {
                const optionKey = option.getAttribute('data-option');
                
                if (optionKey === selectedOption) {
                    option.classList.add(isCorrect ? 'correct-answer' : 'wrong-answer');
                } else if (optionKey === correctAnswer) {
                    option.classList.add('correct-answer-revealed'); 
                }
                
                option.onclick = null;
            });

            // 2. Exibe o comentário
            const commentBox = document.getElementById(`comment-${questionId}`);
            if (commentBox) {
                commentBox.style.display = 'block';
                commentBox.style.backgroundColor = isCorrect ? '#e8f7ec' : '#f7e8e8'; 
                commentBox.style.borderColor = isCorrect ? 'var(--success-color)' : 'var(--danger-color)';
                
                let commentHTML = `<h4>${isCorrect ? '✅ Resposta Correta!' : '❌ Sua Resposta Está Incorreta.'}</h4>`;
                commentHTML += `<p><strong>Gabarito: </strong> Opção ${correctAnswer.toUpperCase()}</p>`;
                
                // Tenta encontrar o comentário em todas as chaves e formatos
                let commentContent = 'Comentário não disponível.';
                
                if (typeof question.comentario === 'object' && question.comentario !== null) {
                    commentContent = question.comentario[correctAnswer.toUpperCase()] || question.comentario[correctAnswer] || question.comentario.A || 'Comentário detalhado não disponível.';
                } 
                else if (question.explicacao_professor) {
                    commentContent = question.explicacao_professor;
                }
                else if (typeof question.comentario === 'string') {
                    commentContent = question.comentario;
                } 
                
                commentHTML += `<div class="comment-content">${commentContent.replace(/\n/g, '<br>')}</div>`;
                commentBox.innerHTML = commentHTML;
            }
        }

        // Função para carregar a lista de simulados na barra lateral
        async function loadSimulados() {
            const list = document.getElementById('simulados-list');
            
            // LISTA DE MANIFESTO ATUALIZADA
            const fallbackFiles =[
                "SIMULADO-DIREITOS-HUMANOS-JSON.json",
                "SIMULADO-IASES-JSON-COM-GABARITO.json",
                "SIMULADO-POLICIA-PENAL02-JSON.json",
                "SIMULADO-POLICIA-PENAL-JSON.json",
                "GERAIS.json",
                "QUESTOES-AREA-POLICIAL.json",
                "SIMULADO-IDCAP-60-QUESTOES.json",
                "002-IDCAP-60-QUESTOES.json",
                "SIMULADO-03-IDCAP-60-QUESTOES.json",
                "LEGISLAÇÃO-ESPECÍFICA.json",
                "SIMULADO-ATUALIDADES-83-QUESTOES.json",
                "ESTRATEGIA-POLICIA-PENAL.json" 
            ];
            
            list.innerHTML = '';
            fallbackFiles.forEach(filename => {
                let cleanName = filename.replace(/\.(json|txt)$/i, ''); 
                cleanName = cleanName.replace(/SIMULADO-|QUESTOES-|NOVO /g, '').trim();
                
                const li = document.createElement('li');
                li.innerHTML = `<a onclick="loadAndRenderQuiz('${filename}')">${cleanName}</a>`;
                list.appendChild(li);
            });
            list.innerHTML += '<li><small style="color:#adb5bd; padding-top: 10px; display: block;">(Lista de Simulados Carregada)</small></li>';
        }

        window.onload = loadSimulados;
    </script>
</body>
</html>

